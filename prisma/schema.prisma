generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model User {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  clerkId         String          @unique
  username        String          @unique
  email           String? // Added for multi-tenant RBAC (optional for migration)
  firstName       String
  lastName        String
  imageUrl        String?
  manager         String?         @default("")
  role            Role            @default(AGENT) // Legacy role enum (can be deprecated later)
  tenantId        String?         @db.ObjectId // Multi-tenant: user belongs to ONE tenant
  tenant          Tenant?         @relation(fields: [tenantId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  points          Int             @default(0)
  lifetimePoints  Int             @default(0)
  pointLogs       PointLog[]
  rewardsRedeemed RewardLog[]
  categoryStats   CategoryStat[]
  AuditLog        AuditLog[]
  currentStreak   Int             @default(0)
  longestStreak   Int             @default(0)
  lastStreakDate  DateTime?
  streakUpdatedAt DateTime?       @default(now())
  systemSettings  SystemSetting[]
  quizzes         Quiz[]
  courses         Course[]
  // Note: userRoles relation removed - UserRole.userId is Clerk ID (String), not User.id (ObjectId)
  // Query user roles by matching User.clerkId with UserRole.userId in application code

  // CRITICAL INDEXES FOR COMMON QUERIES
  @@index([role]) // Filter by role: "Get all managers"
  @@index([points(sort: Desc)]) // Leaderboards: "Top users by points"
  @@index([lifetimePoints(sort: Desc)]) // Lifetime leaderboards
  @@index([createdAt]) // Date-based queries: "Users joined this month"
  @@index([role, points(sort: Desc)]) // Compound: "Top agents by points"
  // TEXT SEARCH INDEXES (if you need name-based search)
  @@index([firstName, lastName]) // Full name search
  @@index([username, firstName, lastName]) // Comprehensive user search
  // Multi-tenant RBAC indexes
  @@index([tenantId]) // Filter users by tenant
  @@index([email]) // Lookup by email
  @@map("users")
}

model Category {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  tenantId      String?        @db.ObjectId // Multi-tenant: null if global, set if tenant-specific
  tenant        Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isGlobal      Boolean        @default(false) // If true, available to all tenants (super-admin managed)
  name          String
  description   String?
  imageUrl      String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  quizzes       Quiz[]
  categoryStats CategoryStat[]
  courses       Course[]

  // INDEXES FOR CATEGORY QUERIES
  @@unique([tenantId, name]) // Category names unique per tenant (null tenantId = global)
  @@index([tenantId]) // Filter categories by tenant
  @@index([isGlobal]) // Filter global categories
  @@index([isActive]) // Filter active categories
  @@index([tenantId, isActive]) // Active categories per tenant
  @@index([isGlobal, isActive]) // Active global categories
  @@index([tenantId, isActive, name]) // Active categories sorted by name per tenant
  @@map("categories")
}

model Quiz {
  id                 String     @id @default(auto()) @map("_id") @db.ObjectId
  tenantId           String?    @db.ObjectId // Multi-tenant: null if global, set if tenant-specific
  tenant             Tenant?    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isGlobal           Boolean    @default(false) // If true, available to all tenants (super-admin managed)
  title              String
  description        String?
  imageUrl           String?
  fileKey            String? // Firebase Storage path for quiz image (similar to Course model)
  categoryId         String     @db.ObjectId
  category           Category   @relation(fields: [categoryId], references: [id])
  questions          Question[]
  isActive           Boolean    @default(true)
  timeLimit          Int?
  passingScore       Int        @default(70)
  lastAttempt        DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  userId             String?    @db.ObjectId
  user               User?      @relation(fields: [userId], references: [id])
  score              Int?
  totalQuestions     Int?
  showQuestionReview Boolean    @default(true)
  showCorrectAnswers Boolean    @default(false)

  // CRITICAL FOREIGN KEY AND QUERY INDEXES
  @@index([tenantId]) // Filter quizzes by tenant
  @@index([isGlobal]) // Filter global quizzes
  @@index([categoryId])
  @@index([isActive])
  @@index([tenantId, isActive]) // Active quizzes per tenant
  @@index([isGlobal, isActive]) // Active global quizzes
  @@index([categoryId, isActive])
  @@index([lastAttempt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([title])
  @@map("quizzes")
}

model Question {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  text     String
  imageUrl String?
  fileKey  String? // Firebase Storage path for question image (similar to Quiz/Course)
  videoUrl String?
  quizId   String   @db.ObjectId
  quiz     Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options  Option[]
  points   Int      @default(1)

  // FOREIGN KEY INDEXES
  @@index([quizId]) // CRITICAL: "Questions for quiz X"
  @@map("questions")
}

//Answers
model Option {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  text       String
  isCorrect  Boolean
  questionId String   @db.ObjectId
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // FOREIGN KEY INDEXES
  @@index([questionId]) // CRITICAL: "Options for question X"
  @@index([questionId, isCorrect]) // Find correct answers
  @@map("options")
}

model CategoryStat {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  tenantId       String    @db.ObjectId // Multi-tenant: user stats are tenant-specific
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId         String    @db.ObjectId
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId     String    @db.ObjectId
  category       Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  attempts       Int       @default(0)
  completed      Int       @default(0)
  averageScore   Float?
  bestScore      Float?
  totalTimeSpent Int       @default(0)
  lastAttempt    DateTime? // Last attempt in this category
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId, categoryId]) // Already exists - prevents duplicates
  // PERFORMANCE INDEXES FOR ANALYTICS
  @@index([tenantId]) // Filter stats by tenant
  @@index([userId]) // User's stats across categories
  @@index([categoryId]) // All users' stats for a category
  @@index([tenantId, userId]) // User's stats per tenant
  @@index([tenantId, categoryId]) // Category stats per tenant
  @@index([userId, lastAttempt(sort: Desc)]) // Recent activity per user
  @@index([categoryId, averageScore(sort: Desc)]) // Category leaderboards
  @@index([tenantId, categoryId, averageScore(sort: Desc)]) // Category leaderboards per tenant
  @@index([categoryId, bestScore(sort: Desc)]) // Best scores per category
  @@index([tenantId, categoryId, bestScore(sort: Desc)]) // Best scores per category per tenant
  @@index([lastAttempt(sort: Desc)]) // Global recent activity
  @@index([averageScore(sort: Desc)]) // Global leaderboards
  @@map("category_stats")
}

model PointLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId  String   @db.ObjectId // Multi-tenant: points are tenant-specific
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Int
  reason    String
  createdAt DateTime @default(now())

  // CRITICAL INDEXES FOR POINT HISTORY
  @@index([tenantId]) // Filter point logs by tenant
  @@index([userId]) // User's point history
  @@index([tenantId, userId]) // User's point history per tenant
  @@index([userId, createdAt(sort: Desc)]) // Recent points for user
  @@index([tenantId, userId, createdAt(sort: Desc)]) // Recent points for user per tenant
  @@index([createdAt(sort: Desc)]) // Global recent point activity
  @@index([reason]) // Filter by reason
  @@index([tenantId, reason]) // Filter by reason per tenant
  @@index([reason, createdAt(sort: Desc)]) // Recent activity by reason
  @@index([userId, reason]) // User's points by reason
  @@index([tenantId, userId, reason]) // User's points by reason per tenant
  @@map("point_logs")
}

model Reward {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  tenantId       String?     @db.ObjectId // Multi-tenant: null if global, set if tenant-specific
  tenant         Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isGlobal       Boolean     @default(false) // If true, available to all tenants (super-admin managed)
  prize          String
  description    String?
  cost           Int
  imageUrl       String?
  fileKey        String? // Firebase Storage path for reward image (similar to Quiz/Course)
  featured       Boolean     @default(false)
  enabled        Boolean     @default(true)
  allowMultiple  Boolean     @default(false)
  maxRedemptions Int         @default(1)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  rewardLogs     RewardLog[]
  claimUrl       String? // Optional URL for digital rewards

  @@index([tenantId]) // Filter rewards by tenant
  @@index([isGlobal]) // Filter global rewards
  @@index([enabled])
  @@index([tenantId, enabled]) // Enabled rewards per tenant
  @@index([isGlobal, enabled]) // Enabled global rewards
  @@index([featured])
  @@index([tenantId, featured]) // Featured rewards per tenant
  @@index([isGlobal, featured]) // Featured global rewards
  @@index([prize])
  @@map("rewards")
}

model RewardLog {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  tenantId    String    @db.ObjectId // Multi-tenant: redemptions are tenant-specific
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rewardId    String    @db.ObjectId
  reward      Reward    @relation(fields: [rewardId], references: [id])
  redeemed    Boolean   @default(false)
  pointsSpent Int
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  claimed     Boolean   @default(false)
  claimUrl    String?
  claimedAt   DateTime?

  // REWARD TRACKING INDEXES
  @@index([tenantId]) // Filter redemptions by tenant
  @@index([userId]) // User's redemption history
  @@index([tenantId, userId]) // User's redemption history per tenant
  @@index([rewardId]) // Reward popularity tracking
  @@index([tenantId, rewardId]) // Reward popularity per tenant
  @@index([redeemed]) // Filter by redemption status
  @@index([tenantId, redeemed]) // Redemption status per tenant
  @@index([userId, redeemed]) // User's redemption status
  @@index([tenantId, userId, redeemed]) // User's redemption status per tenant
  @@index([userId, createdAt(sort: Desc)]) // Recent redemptions per user
  @@index([tenantId, userId, createdAt(sort: Desc)]) // Recent redemptions per user per tenant
  @@index([createdAt(sort: Desc)]) // Global recent redemptions
  @@map("reward_logs")
}

model Game {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  tenantId   String? @db.ObjectId // Multi-tenant: null if global, set if tenant-specific
  tenant     Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isGlobal   Boolean @default(false) // If true, available to all tenants (super-admin managed)
  title      String
  description String?
  imageUrl    String?
  slug        String
  genre       String?
  rules       Rule[] // One-to-many relationship

  @@unique([tenantId, slug]) // Game slugs unique per tenant (null tenantId = global)
  // GAME TRACKING INDEXES
  @@index([tenantId]) // Filter games by tenant
  @@index([isGlobal]) // Filter global games
  @@index([title]) // Search for title
  @@index([tenantId, title]) // Search for title per tenant
  @@index([isGlobal, title]) // Search global games by title
  @@index([genre(sort: Desc)]) // Sort by genre
  @@index([tenantId, genre(sort: Desc)]) // Sort by genre per tenant
  @@index([isGlobal, genre(sort: Desc)]) // Sort global games by genre
  @@map("games")
}

model Rule {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  text   String
  gameId String @db.ObjectId
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId   String   @db.ObjectId // Multi-tenant: audit logs are tenant-scoped for security/compliance
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String
  details    String?
  resource   String? // e.g., "reward", "user", "points"
  resourceId String?  @db.ObjectId
  timestamp  DateTime @default(now())

  // AUDIT LOG INDEXES
  @@index([tenantId]) // Filter audit logs by tenant (critical for security)
  @@index([userId])
  @@index([tenantId, userId]) // User's audit logs per tenant
  @@index([action])
  @@index([tenantId, action]) // Actions per tenant
  @@index([resource])
  @@index([tenantId, resource]) // Resources per tenant
  @@index([timestamp(sort: Desc)])
  @@index([tenantId, timestamp(sort: Desc)]) // Recent logs per tenant
  @@index([userId, timestamp(sort: Desc)])
  @@index([tenantId, userId, timestamp(sort: Desc)]) // User's recent logs per tenant
  @@map("audit_logs")
}

model SystemSetting {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId    String   @db.ObjectId // Multi-tenant: settings are tenant-specific
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key         String
  value       String
  description String?
  category    String   @default("general")
  updatedAt   DateTime @updatedAt
  updatedBy   String?  @db.ObjectId
  user        User?    @relation(fields: [updatedBy], references: [id])

  @@unique([tenantId, key]) // Setting keys unique per tenant
  @@index([tenantId]) // Filter settings by tenant
  @@index([tenantId, category]) // Settings by category per tenant
  @@map("system_settings")
}

model Course {
  id                 String       @id @default(auto()) @map("_id") @db.ObjectId
  tenantId           String?      @db.ObjectId // Multi-tenant: null if global, set if tenant-specific
  tenant             Tenant?      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isGlobal           Boolean      @default(false) // If true, available to all tenants (super-admin managed)
  title              String
  description        String
  fileKey            String
  duration           Int
  categoryId         String       @db.ObjectId
  category           Category     @relation(fields: [categoryId], references: [id])
  excerptDescription String
  slug               String
  status             CourseStatus @default(Draft)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  userId             String?      @db.ObjectId
  user               User?        @relation(fields: [userId], references: [id])

  @@unique([tenantId, slug]) // Course slugs unique per tenant (null tenantId = global)
  @@index([tenantId]) // Filter courses by tenant
  @@index([isGlobal]) // Filter global courses
  @@index([tenantId, status]) // Courses by status per tenant
  @@index([isGlobal, status]) // Global courses by status
  @@index([categoryId])
  @@map("courses")
}

enum Role {
  AGENT
  MANAGER
  OPERATIONS
}

enum CourseStatus {
  Published
  Draft
  Achieved
}

// ============================================
// MULTI-TENANT RBAC MODELS
// ============================================
// 
// GLOBAL CONTENT PATTERN:
// - Quiz, Course, Game, Reward, and Category support global content
// - When isGlobal=true and tenantId=null, content is available to ALL tenants
// - Super admins manage global content from CMS
// - To query available content for a tenant:
//   WHERE (tenantId = 'tenantId' OR (isGlobal = true AND tenantId IS NULL))
// - Tenant relations (tenant.quizzes, etc.) only include tenant-specific content
//   (where tenantId matches). Global content must be queried separately.

// Core tenant model
model Tenant {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  slug                 String   @unique
  subscriptionTier     String   @default("free") // free, pro, enterprise
  subscriptionStatus   String   @default("active") // active, trialing, past_due, canceled, etc.
  maxRoleSlots         Int      @default(5)
  baseRoleSlots        Int      @default(5)
  purchasedRoleSlots   Int      @default(0)
  
  // Stripe integration fields
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  stripePriceId        String?  // Current price ID
  billingInterval      String?  // monthly, annually
  trialEndsAt          DateTime?
  subscriptionEndsAt   DateTime? // When current period ends
  cancelAtPeriodEnd    Boolean  @default(false)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  tenantRoles       TenantRole[]
  userRoles         UserRole[]
  roleSlotPurchases RoleSlotPurchase[]
  users             User[]
  categories        Category[]
  quizzes           Quiz[]
  courses           Course[]
  rewards           Reward[]
  rewardLogs        RewardLog[]
  categoryStats     CategoryStat[]
  pointLogs         PointLog[]
  auditLogs         AuditLog[]
  systemSettings    SystemSetting[]
  games             Game[]
  tenantFeatures    TenantFeature[]

  // Note: @@unique([slug]) already creates an index, no need for @@index([slug])
  @@index([stripeCustomerId]) // Stripe integration
  @@index([stripeSubscriptionId]) // Stripe integration
  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@map("tenants")
}

// Global permissions catalog (super admin manages)
model Permission {
  id                      String       @id @default(auto()) @map("_id") @db.ObjectId
  name                    String       @unique // e.g., "users.create", "content.read"
  displayName             String // e.g., "Create Users"
  description             String?
  category                String // e.g., "user_management", "content"
  isDeprecated            Boolean      @default(false)
  deprecatedAt            DateTime?
  replacementPermissionId String?      @db.ObjectId
  replacementPermission   Permission?  @relation("PermissionReplacement", fields: [replacementPermissionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replacedPermissions     Permission[] @relation("PermissionReplacement")
  sunsetDate              DateTime?
  isActive                Boolean      @default(true)
  createdAt               DateTime     @default(now())

  // Relations
  roleTemplatePermissions RoleTemplatePermission[]
  tenantRolePermissions   TenantRolePermission[]

  // Note: @@unique([name]) already creates an index, no need for @@index([name])
  @@index([category]) // Filter by category
  @@index([isActive]) // Filter active permissions
  @@index([isDeprecated]) // Filter deprecated permissions
  @@map("permissions")
}

// Role templates for onboarding (super admin creates)
model RoleTemplate {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  templateSetName String // e.g., "generic", "education"
  roleName        String // e.g., "Administrator", "Manager"
  description     String?
  slotPosition    Int // 1-5
  isDefaultSet    Boolean  @default(false)
  createdAt       DateTime @default(now())

  // Relations
  roleTemplatePermissions RoleTemplatePermission[]
  tenantRoles             TenantRole[]

  @@index([templateSetName]) // Filter by template set
  @@index([slotPosition]) // Filter by slot position
  @@index([isDefaultSet]) // Filter default templates
  @@map("role_templates")
}

// Permissions assigned to role templates
model RoleTemplatePermission {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  roleTemplateId String       @db.ObjectId
  roleTemplate   RoleTemplate @relation(fields: [roleTemplateId], references: [id], onDelete: Cascade)
  permissionId   String       @db.ObjectId
  permission     Permission   @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@unique([roleTemplateId, permissionId])
  @@index([roleTemplateId]) // Get all permissions for a template
  @@index([permissionId]) // Find all templates with a permission
  @@map("role_template_permissions")
}

// Tenant-specific roles (tenant admin creates)
model TenantRole {
  id                    String        @id @default(auto()) @map("_id") @db.ObjectId
  tenantId              String        @db.ObjectId
  tenant                Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  roleAlias             String // Custom name like "Teacher", "Manager"
  description           String?
  slotPosition          Int
  isActive              Boolean       @default(true)
  createdFromTemplateId String?       @db.ObjectId
  createdFromTemplate   RoleTemplate? @relation(fields: [createdFromTemplateId], references: [id])
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  tenantRolePermissions TenantRolePermission[]
  userRoles             UserRole[]

  @@unique([tenantId, roleAlias])
  @@index([tenantId]) // Get all roles for a tenant
  @@index([tenantId, isActive]) // Get active roles for a tenant
  @@index([slotPosition]) // Filter by slot position
  @@map("tenant_roles")
}

// Permissions assigned to tenant roles
model TenantRolePermission {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  tenantRoleId String     @db.ObjectId
  tenantRole   TenantRole @relation(fields: [tenantRoleId], references: [id], onDelete: Cascade)
  permissionId String     @db.ObjectId
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  assignedAt   DateTime   @default(now())

  @@unique([tenantRoleId, permissionId])
  @@index([tenantRoleId]) // Get all permissions for a role
  @@index([permissionId]) // Find all roles with a permission
  @@map("tenant_role_permissions")
}

// User to role assignments
model UserRole {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  userId       String // Clerk user ID (not ObjectId, as it's from Clerk)
  tenantId     String     @db.ObjectId
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantRoleId String     @db.ObjectId
  tenantRole   TenantRole @relation(fields: [tenantRoleId], references: [id], onDelete: Cascade)
  assignedAt   DateTime   @default(now())
  assignedBy   String? // Clerk user ID of admin who assigned

  @@unique([userId, tenantRoleId])
  @@index([userId]) // Get all roles for a user
  @@index([tenantId]) // Get all users in a tenant
  @@index([tenantId, userId]) // Get user's roles in a tenant
  @@index([tenantRoleId]) // Get all users with a role
  @@map("user_roles")
}

// Track additional role slot purchases
model RoleSlotPurchase {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  tenantId          String    @db.ObjectId
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slotsPurchased    Int
  unitPrice         Float
  totalPrice        Float
  billingCycleStart DateTime?
  billingCycleEnd   DateTime?
  stripeInvoiceId   String?
  status            String    @default("active") // active, cancelled, expired
  purchasedAt       DateTime  @default(now())

  @@index([tenantId]) // Get all purchases for a tenant
  @@index([status]) // Filter by status
  @@index([stripeInvoiceId]) // Stripe integration
  @@index([purchasedAt(sort: Desc)]) // Recent purchases
  @@map("role_slot_purchases")
}

// ============================================
// TENANT FEATURE MANAGEMENT
// ============================================
// 
// Feature flags that can be enabled/disabled per tenant.
// Super admins can set global defaults and override per tenant.
// Tenant admins can enable/disable features (within what super admin allows).

// Global feature definitions (managed by super admin)
model Feature {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  key             String          @unique // e.g., "games", "course_quizzes", "leaderboards"
  name            String // Display name e.g., "Games", "Course Quizzes", "Leaderboards"
  description     String?
  category        String          @default("general") // e.g., "gamification", "learning", "social"
  defaultEnabled  Boolean         @default(true) // Default state for new tenants
  isActive        Boolean         @default(true) // If false, feature is globally disabled
  icon            String? // Icon name for UI (e.g., "Gamepad2", "Trophy")
  sortOrder       Int             @default(0) // For UI ordering
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  tenantFeatures  TenantFeature[]

  @@index([category])
  @@index([isActive])
  @@index([sortOrder])
  @@map("features")
}

// Tenant-specific feature settings
model TenantFeature {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId              String   @db.ObjectId
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  featureId             String   @db.ObjectId
  feature               Feature  @relation(fields: [featureId], references: [id], onDelete: Cascade)
  enabled               Boolean  @default(true) // Tenant admin can toggle (if superAdminEnabled is true)
  superAdminEnabled     Boolean  @default(true) // Super admin override - if false, tenant admin cannot enable
  superAdminLockedAt    DateTime? // When super admin locked/unlocked the feature
  lastToggledAt         DateTime? // When tenant admin last toggled
  lastToggledBy         String? // Clerk user ID of who last toggled
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([tenantId, featureId])
  @@index([tenantId])
  @@index([featureId])
  @@index([tenantId, enabled])
  @@index([enabled])
  @@map("tenant_features")
}
